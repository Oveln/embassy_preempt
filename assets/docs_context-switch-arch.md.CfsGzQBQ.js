import{_ as p,C as h,c as B,o as E,a0 as t,b as n,j as A,w as a,a as i,G as l,a1 as r}from"./chunks/framework.C1J0Vcxi.js";const g=JSON.parse('{"title":"ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶æ„è®¾è®¡","description":"","frontmatter":{"title":"ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶æ„è®¾è®¡","date":"2025-11-29"},"headers":[],"relativePath":"docs/context-switch-arch.md","filePath":"docs/context-switch-arch.md"}'),o={name:"docs/context-switch-arch.md"};function d(k,s,c,C,F,D){const e=h("Mermaid");return E(),B("div",null,[s[2]||(s[2]=t('<h1 id="embassy-preempt-ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶æ„è®¾è®¡" tabindex="-1">Embassy Preempt ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶æ„è®¾è®¡ <a class="header-anchor" href="#embassy-preempt-ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶æ„è®¾è®¡" aria-label="Permalink to &quot;Embassy Preempt ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶æ„è®¾è®¡&quot;">â€‹</a></h1><h2 id="ğŸ¯-æ ¸å¿ƒè®¾è®¡åŸåˆ™" tabindex="-1">ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™ <a class="header-anchor" href="#ğŸ¯-æ ¸å¿ƒè®¾è®¡åŸåˆ™" aria-label="Permalink to &quot;ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™&quot;">â€‹</a></h2><p><strong>æ‰€æœ‰å¹³å°çš„å¯„å­˜å™¨ä¿å­˜éƒ½åœ¨è¿›å…¥<code>__ContextSwitchHandler</code>å‡½æ•°ä¸­é€šè¿‡<code>save_task_context()</code>ç»Ÿä¸€å®Œæˆ</strong></p><h2 id="ğŸ“‹-æ­£ç¡®çš„æ¶æ„æµç¨‹å›¾" tabindex="-1">ğŸ“‹ æ­£ç¡®çš„æ¶æ„æµç¨‹å›¾ <a class="header-anchor" href="#ğŸ“‹-æ­£ç¡®çš„æ¶æ„æµç¨‹å›¾" aria-label="Permalink to &quot;ğŸ“‹ æ­£ç¡®çš„æ¶æ„æµç¨‹å›¾&quot;">â€‹</a></h2>',4)),(E(),n(r,null,{default:a(()=>[l(e,{id:"mermaid-12",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20A%5B%E8%B0%83%E5%BA%A6%E5%99%A8%E8%A7%A6%E5%8F%91%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%5D%20--%3E%20B%7B%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%7D%0A%0A%20%20%20%20%25%25%20ARM%20Cortex-M%20%E8%B7%AF%E5%BE%84%0A%20%20%20%20B%20--%3E%7CARM%20Cortex-M%7C%20C%5BNVIC%E5%AF%84%E5%AD%98%E5%99%A8%E8%AE%BE%E7%BD%AEPendSV%5D%0A%20%20%20%20C%20--%3E%20D%5BPendSV%E5%BC%82%E5%B8%B8%E8%87%AA%E5%8A%A8%E8%A7%A6%E5%8F%91%5D%0A%20%20%20%20D%20--%3E%20E%5B%E7%A1%AC%E4%BB%B6%E8%87%AA%E5%8A%A8%E4%BF%9D%E5%AD%98%E9%83%A8%E5%88%86%E5%AF%84%E5%AD%98%E5%99%A8%3Cbr%2F%3ER0-R3%2C%20R12%2C%20LR%2C%20PC%2C%20xPSR%5D%0A%20%20%20%20E%20--%3E%20F%5B__ContextSwitchHandler%E7%BB%9F%E4%B8%80%E5%85%A5%E5%8F%A3%5D%0A%0A%20%20%20%20%25%25%20RISC-V%20%E8%B7%AF%E5%BE%84%0A%20%20%20%20B%20--%3E%7CRISC-V%7C%20G%5Becall%E6%8C%87%E4%BB%A4%E8%A7%A6%E5%8F%91%5D%0A%20%20%20%20G%20--%3E%20H%5BMachineEnvCall%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%5D%0A%20%20%20%20H%20--%3E%20I%5B%E4%BB%85%E5%81%9A%E6%A0%88%E5%88%87%E6%8D%A2%3Cbr%2F%3Ecsrrw%20sp%2C%20mscratch%2C%20sp%5D%0A%20%20%20%20I%20--%3E%20F%0A%0A%20%20%20%20%25%25%20%E7%BB%9F%E4%B8%80%E5%A4%84%E7%90%86%0A%20%20%20%20F%20--%3E%20J%5B%E8%B0%83%E7%94%A8Platform%3A%3Asave_task_context%5D%0A%20%20%20%20J%20--%3E%20K%5B%E8%A1%A5%E5%85%A8%2F%E4%BF%9D%E5%AD%98%E6%89%80%E6%9C%89%E5%AF%84%E5%AD%98%E5%99%A8%E5%88%B0%E6%A0%88%5D%0A%20%20%20%20K%20--%3E%20L%5B%E6%89%A7%E8%A1%8C%E5%B9%B3%E5%8F%B0%E6%97%A0%E5%85%B3%E7%9A%84%E8%B0%83%E5%BA%A6%E9%80%BB%E8%BE%91%5D%0A%20%20%20%20L%20--%3E%20M%5B%E9%80%89%E6%8B%A9%E6%9C%80%E9%AB%98%E4%BC%98%E5%85%88%E7%BA%A7%E4%BB%BB%E5%8A%A1%5D%0A%20%20%20%20M%20--%3E%20N%5B%E8%B0%83%E7%94%A8Platform%3A%3Arestore_task_context%5D%0A%20%20%20%20N%20--%3E%20O%5B%E6%81%A2%E5%A4%8D%E5%AF%84%E5%AD%98%E5%99%A8%E5%B9%B6%E5%88%87%E6%8D%A2%E5%88%B0%E6%96%B0%E4%BB%BB%E5%8A%A1%5D%0A"})]),fallback:a(()=>[...s[0]||(s[0]=[i(" Loading... ",-1)])]),_:1})),s[3]||(s[3]=A("h2",{id:"ğŸ”-è¯¦ç»†æ—¶åºå›¾",tabindex:"-1"},[i("ğŸ” è¯¦ç»†æ—¶åºå›¾ "),A("a",{class:"header-anchor",href:"#ğŸ”-è¯¦ç»†æ—¶åºå›¾","aria-label":'Permalink to "ğŸ” è¯¦ç»†æ—¶åºå›¾"'},"â€‹")],-1)),(E(),n(r,null,{default:a(()=>[l(e,{id:"mermaid-16",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20App%20as%20%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%0A%20%20%20%20participant%20Sched%20as%20%E8%B0%83%E5%BA%A6%E5%99%A8%0A%20%20%20%20participant%20IRQ%20as%20%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%0A%20%20%20%20participant%20CS%20as%20__ContextSwitchHandler%0A%20%20%20%20participant%20PF%20as%20Platform%E5%87%BD%E6%95%B0%0A%0A%20%20%20%20App-%3E%3ESched%3A%20%E8%A7%A6%E5%8F%91%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%0A%0A%20%20%20%20alt%20ARM%E5%B9%B3%E5%8F%B0%0A%20%20%20%20%20%20%20%20Sched-%3E%3EIRQ%3A%20%E8%AE%BE%E7%BD%AENVIC%E5%AF%84%E5%AD%98%E5%99%A8%0A%20%20%20%20%20%20%20%20Note%20over%20IRQ%3A%20PendSV%E7%A1%AC%E4%BB%B6%E8%A7%A6%E5%8F%91%0A%20%20%20%20%20%20%20%20IRQ-%3E%3EIRQ%3A%20%E8%87%AA%E5%8A%A8%E4%BF%9D%E5%AD%98%E9%83%A8%E5%88%86%E5%AF%84%E5%AD%98%E5%99%A8%0A%20%20%20%20%20%20%20%20IRQ-%3E%3ECS%3A%20%E8%B7%B3%E8%BD%AC%E5%88%B0__ContextSwitchHandler%0A%20%20%20%20else%20RISC-V%E5%B9%B3%E5%8F%B0%0A%20%20%20%20%20%20%20%20Sched-%3E%3EIRQ%3A%20%E6%89%A7%E8%A1%8Cecall%E6%8C%87%E4%BB%A4%0A%20%20%20%20%20%20%20%20IRQ-%3E%3EIRQ%3A%20csrrw%20sp%2C%20mscratch%2C%20sp%20(%E4%BB%85%E6%A0%88%E5%88%87%E6%8D%A2)%0A%20%20%20%20%20%20%20%20IRQ-%3E%3ECS%3A%20%E8%B7%B3%E8%BD%AC%E5%88%B0__ContextSwitchHandler%0A%20%20%20%20end%0A%0A%20%20%20%20CS-%3E%3EPF%3A%20%E8%B0%83%E7%94%A8save_task_context()%0A%20%20%20%20Note%20over%20PF%3A%20%E7%BB%9F%E4%B8%80%E4%BF%9D%E5%AD%98%E6%89%80%E6%9C%89%E5%AF%84%E5%AD%98%E5%99%A8%0A%20%20%20%20PF-%3E%3EPF%3A%20%E5%AE%8C%E6%88%90%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BF%9D%E5%AD%98%0A%20%20%20%20PF-%3E%3ECS%3A%20%E8%BF%94%E5%9B%9E%0A%0A%20%20%20%20CS-%3E%3ECS%3A%20%E6%89%A7%E8%A1%8C%E5%B9%B3%E5%8F%B0%E6%97%A0%E5%85%B3%E8%B0%83%E5%BA%A6%E9%80%BB%E8%BE%91%0A%20%20%20%20CS-%3E%3ECS%3A%20%E9%80%89%E6%8B%A9%E6%96%B0%E4%BB%BB%E5%8A%A1%0A%20%20%20%20CS-%3E%3EPF%3A%20%E8%B0%83%E7%94%A8restore_task_context()%0A%20%20%20%20Note%20over%20PF%3A%20%E7%BB%9F%E4%B8%80%E6%81%A2%E5%A4%8D%E5%AF%84%E5%AD%98%E5%99%A8%0A%20%20%20%20PF-%3E%3EPF%3A%20%E5%AE%8C%E6%88%90%E4%B8%8A%E4%B8%8B%E6%96%87%E6%81%A2%E5%A4%8D%0A%20%20%20%20PF-%3E%3EApp%3A%20%E8%BF%94%E5%9B%9E%E5%88%B0%E6%96%B0%E4%BB%BB%E5%8A%A1%0A"})]),fallback:a(()=>[...s[1]||(s[1]=[i(" Loading... ",-1)])]),_:1})),s[4]||(s[4]=t(`<h2 id="âœ…-å…³é”®è®¾è®¡æ­£ç¡®æ€§éªŒè¯" tabindex="-1">âœ… å…³é”®è®¾è®¡æ­£ç¡®æ€§éªŒè¯ <a class="header-anchor" href="#âœ…-å…³é”®è®¾è®¡æ­£ç¡®æ€§éªŒè¯" aria-label="Permalink to &quot;âœ… å…³é”®è®¾è®¡æ­£ç¡®æ€§éªŒè¯&quot;">â€‹</a></h2><h3 id="_1-ç»Ÿä¸€çš„å…¥å£ç‚¹" tabindex="-1">1. ç»Ÿä¸€çš„å…¥å£ç‚¹ <a class="header-anchor" href="#_1-ç»Ÿä¸€çš„å…¥å£ç‚¹" aria-label="Permalink to &quot;1. ç»Ÿä¸€çš„å…¥å£ç‚¹&quot;">â€‹</a></h3><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸¤ä¸ªå¹³å°æœ€ç»ˆéƒ½è¿›å…¥ç›¸åŒçš„å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsafe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(no_mangle)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extern</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;C&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> __ContextSwitchHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. ç»Ÿä¸€è°ƒç”¨å¹³å°ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsafe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        embassy_preempt_platform</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PlatformImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save_task_context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. æ‰§è¡Œå¹³å°æ— å…³çš„è°ƒåº¦é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> global_executor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GlobalSyncExecutor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">as_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unwrap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... è°ƒåº¦ç®—æ³•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2-risc-vå¼‚å¸¸å…¥å£çš„æœ€å°åŒ–è®¾è®¡" tabindex="-1">2. RISC-Vå¼‚å¸¸å…¥å£çš„æœ€å°åŒ–è®¾è®¡ <a class="header-anchor" href="#_2-risc-vå¼‚å¸¸å…¥å£çš„æœ€å°åŒ–è®¾è®¡" aria-label="Permalink to &quot;2. RISC-Vå¼‚å¸¸å…¥å£çš„æœ€å°åŒ–è®¾è®¡&quot;">â€‹</a></h3><div class="language-assembly vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">assembly</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># æ­£ç¡®ï¼šåªåšæ ˆåˆ‡æ¢ï¼Œä¸ä¿å­˜å¯„å­˜å™¨</span></span>
<span class="line"><span>MachineEnvCall:</span></span>
<span class="line"><span>    csrrw sp, mscratch, sp    # ä»…åˆ‡æ¢æ ˆæŒ‡é’ˆ</span></span>
<span class="line"><span>    j __ContextSwitchHandler # è·³è½¬åˆ°ç»Ÿä¸€å¤„ç†å‡½æ•°</span></span></code></pre></div><h3 id="_3-armå’Œrisc-vçš„ä¸€è‡´æ€§ä¿è¯" tabindex="-1">3. ARMå’ŒRISC-Vçš„ä¸€è‡´æ€§ä¿è¯ <a class="header-anchor" href="#_3-armå’Œrisc-vçš„ä¸€è‡´æ€§ä¿è¯" aria-label="Permalink to &quot;3. ARMå’ŒRISC-Vçš„ä¸€è‡´æ€§ä¿è¯&quot;">â€‹</a></h3><ul><li><strong>ARM</strong>: PendSV + éƒ¨åˆ†ç¡¬ä»¶ä¿å­˜ + <code>save_task_context()</code>è¡¥å…¨</li><li><strong>RISC-V</strong>: ecall + æ ˆåˆ‡æ¢ + <code>save_task_context()</code>å®Œæ•´ä¿å­˜</li><li><strong>ç»“æœ</strong>: ä¸¤ä¸ªå¹³å°éƒ½ä»¥ç›¸åŒçŠ¶æ€è¿›å…¥è°ƒåº¦å™¨</li></ul>`,7))])}const m=p(o,[["render",d]]);export{g as __pageData,m as default};
